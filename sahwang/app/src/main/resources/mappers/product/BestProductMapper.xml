<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.green.sahwang.product.mapper.ProductMapper">
    <!-- 쿼리 정의 -->
    <select id="findBestProduct" resultType="com.green.sahwang.mainpage.dto.BestProductResDto">
        SELECT
        p.product_id productId,
        p.name productName,
        p.brand_id brandId,
        p.main_image mainImage,
        p.dtype dtype
        FROM product p
        WHERE p.product_id IN(
        SELECT pcc.product_id
        FROM
        (
            SELECT pc.product_id, MAX(pc.product_count) maxCount
            FROM (
                SELECT p.product_id, COUNT(p.product_id) product_count
                from used_product up
                INNER JOIN verified_sale vs ON vs.verified_sale_id = up.verified_sale_id
                INNER JOIN pending_sale ps ON ps.pending_sale_id = vs.pending_sale_id
                INNER JOIN product p ON p.product_id = ps.product_id
                where up.sold_out = true
                AND ps.inspection_status = 'SOLD'
                GROUP BY p.product_id) pc
            GROUP BY pc.product_id) pcc
        )
    </select>
</mapper>
