<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.green.sahwang.product.mapper.ProductMapper">

    <!-- ResultMap 정의 -->
    <resultMap id="ProductWithSaleInfoDtoResultMap" type="com.green.sahwang.dto.response.ProductWithSaleInfoDto">
        <result property="minPrice" column="minPrice" />
        <result property="maxPrice" column="maxPrice" />
        <result property="minSize" column="minSize" />
        <result property="maxSize" column="maxSize" />
        <association property="product" column="productId" javaType="com.green.sahwang.entity.Product"
                     select="com.green.sahwang.product.mapper.ProductMapper.findProductById"/>
    </resultMap>

    <!-- 쿼리 정의 -->
    <select id="findProductsWithInUsedSaleInfo" resultMap="ProductWithSaleInfoDtoResultMap">
        SELECT
        p.product_id AS productId,
        p.name AS name,
        p.content AS content,
        p.dtype AS dtype,
        p.brand_id AS brandId,
        p.size AS size,
        p.price AS price,
        pp.minPrice AS minPrice,
        pp.maxPrice AS maxPrice,
        pp.minSize AS minSize,
        pp.maxSize AS maxSize
        FROM product p
        LEFT OUTER JOIN (
        SELECT
        p.product_id,
        MIN(ps.excepted_selling_price) AS minPrice,
        MAX(ps.excepted_selling_price) AS maxPrice,
        MIN(vs.product_size) AS minSize,
        MAX(vs.product_size) AS maxSize
        FROM product p
        INNER JOIN pending_sale ps ON p.product_id = ps.product_id
        INNER JOIN verified_sale vs ON ps.pending_sale_id = vs.pending_sale_id
        INNER JOIN used_product up ON vs.verified_sale_id = up.verified_sale_id
        WHERE up.used_product_type = 'USER_ACCEPT'
        AND p.dtype = #{dtype}
        GROUP BY p.product_id
        ) pp ON p.product_id = pp.product_id
        WHERE p.dtype = #{dtype}
        <!-- 페이징 처리 -->
        LIMIT #{pageable.offset}, #{pageable.pageSize}
    </select>


    <resultMap id="ProductResultMap" type="com.green.sahwang.entity.Product">
        <id property="id" column="product_id" />
        <result property="name" column="name" />
        <result property="content" column="content" />
        <result property="dtype" column="dtype" />
        <association property="brand" column="brand_id" javaType="com.green.sahwang.brand.entity.Brand"
                     select="com.green.sahwang.brand.mapper.BrandMapper.findBrandById"/>
        <discriminator javaType="string" column="dtype">
            <case value="P" resultType="com.green.sahwang.entity.product.Perfume" />
            <case value="C" resultType="com.green.sahwang.entity.product.Candle" />
            <case value="D" resultType="com.green.sahwang.entity.product.Diffuser" />
        </discriminator>
    </resultMap>
    <!-- 별도의 Product 조회 쿼리 -->
    <select id="findProductById" resultMap="ProductResultMap">
        SELECT * FROM product WHERE product_id = #{productId}
    </select>

</mapper>
